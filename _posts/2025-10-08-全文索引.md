好的，我们来详细讲解 MySQL 中的**全文索引**。

全文索引是一种专为**文本内容搜索**设计的特殊数据库索引。与传统的 `LIKE` 语句或正则表达式相比，它能极大地提升在大文本字段中搜索关键词的效率和质量。

### 1. 什么是全文索引？

*   **传统索引（如 B-Tree）**：擅长精确匹配（`=`）和范围查询（`<`, `>`），或者前缀匹配（`LIKE 'keyword%'`）。但对于 `LIKE '%keyword%'` 这种包含性查询，它需要全表扫描，效率极低。
*   **全文索引**：它构建了一个“单词列表”（词典），并记录了每个单词出现在哪些表的哪些行中。这使得它能够快速找到包含一个或多个单词的所有行，而无需扫描整个表。

**核心思想**：**空间换时间**，通过预先建立好的倒排索引，实现快速的全文检索。

### 2. MySQL 中全文索引的发展

MySQL 的全文索引主要有两个阶段：

1.  **MyISAM 全文索引（MySQL 5.6 之前）**
    *   最初仅支持 MyISAM 存储引擎。
    *   功能相对基础，性能和扩展性有限。

2.  **InnoDB 全文索引（MySQL 5.6 及以后）**
    *   从 MySQL 5.6 开始，InnoDB 也支持全文索引。
    *   **这是目前的主流和推荐选择**，因为它支持事务、行级锁等特性，避免了 MyISAM 的表级锁问题。

### 3. 创建全文索引

你可以在创建表时定义全文索引，也可以在已存在的表上添加。

**语法：**
```sql
-- 创建表时定义
CREATE TABLE articles (
    id INT UNSIGNED AUTO_INCREMENT NOT NULL PRIMARY KEY,
    title VARCHAR(200),
    body TEXT,
    FULLTEXT (title, body) -- 在 title 和 body 列上创建联合全文索引
) ENGINE=InnoDB;

-- 在已存在表上添加
ALTER TABLE articles ADD FULLTEXT idx_ft_title_body (title, body);

-- 或者创建仅单列的索引
ALTER TABLE articles ADD FULLTEXT idx_ft_body (body);
```

### 4. 使用全文索引进行搜索：MATCH() ... AGAINST()

使用 `MATCH() ... AGAINST()` 语法来执行全文搜索。

**基本语法：**
```sql
SELECT column_list FROM table_name 
WHERE MATCH(column1, column2, ...) AGAINST('search_string');
```
*   `MATCH()` 子句中列出的列必须与全文索引定义的列完全一致。
*   `AGAINST()` 中包含要搜索的关键词。

#### 搜索模式

全文搜索主要有三种模式：

**1. 自然语言模式**
这是默认模式。它理解搜索字符串是一个人类自然的查询短语。

*   **特性**：
    *   会依据单词在文本中出现的频率进行相关性计算。一个词在数据集中越常见，其权重越低（例如，“the”, “is” 这种停用词的权重为0）。
    *   结果会自动按**相关性分数**降序排列。
    *   可以使用 `IN NATURAL LANGUAGE MODE` 显式指定，但通常省略。

**示例：**
```sql
-- 搜索包含 'database' 和 'performance' 的文章，按相关性排序
SELECT id, title, 
       MATCH (title, body) AGAINST ('database performance') AS score
FROM articles
WHERE MATCH (title, body) AGAINST ('database performance')
ORDER BY score DESC;
```

**2. 布尔模式**
提供了一种更高级、更强大的查询方式，允许使用操作符来精确控制搜索逻辑。

*   **特性**：
    *   不自动计算相关性排序。
    *   可以使用以下操作符：
        *   `+`：**必须**包含。`+keyword`
        *   `-`：**必须不**包含。`-keyword`
        *   `>`：提高该词的贡献值。
        *   `<`：降低该词的贡献值。
        *   `()`：将单词分组为子表达式。
        *   `~`：否定操作，降低词的贡献值。
        *   `*`：通配符，放在词尾表示前缀匹配。`key*`
        *   `"”`：双引号内的内容作为一个完整的短语进行搜索。

**示例：**
```sql
-- 搜索必须包含 "MySQL"，必须不包含 "Oracle" 的记录
SELECT id, title
FROM articles
WHERE MATCH (title, body) AGAINST ('+MySQL -Oracle' IN BOOLEAN MODE);

-- 搜索以 "data" 开头的单词（如 database, datawarehouse）
SELECT id, title
FROM articles
WHERE MATCH (title, body) AGAINST ('data*' IN BOOLEAN MODE);

-- 搜索完整的短语 "high performance computing"
SELECT id, title
FROM articles
WHERE MATCH (title, body) AGAINST ('"high performance computing"' IN BOOLEAN MODE);
```

**3. 查询扩展模式**
主要用于**扩大搜索范围**。它首先执行一次原始搜索，然后利用第一次搜索的结果中**最相关的一些行**中的词汇，将其加入到原始查询中，再进行第二次搜索。这有助于找到那些不直接包含原关键词但主题相关的文档。

*   使用 `WITH QUERY EXPANSION` 开启。

**示例：**
```sql
-- 如果搜索 "DBMS"，可能会把包含 "MySQL", "PostgreSQL", "index" 等相关内容的文章也找出来
SELECT id, title
FROM articles
WHERE MATCH (title, body) AGAINST ('DBMS' WITH QUERY EXPANSION);
```

### 5. 核心概念与限制

1.  **停用词**
    *   全文索引会忽略一些非常常见、没有实际语义的单词，如 “the”, “a”, “an”, “in” 等，这些被称为停用词。
    *   MySQL 有内置的停用词列表，也可以自定义。

2.  **最小词长**
    *   InnoDB 默认忽略长度小于3个字符的单词（如 “be”, “it”）。MyISAM 默认是4。
    *   这个值可以通过配置参数 `innodb_ft_min_token_size` 和 `ft_min_word_len` 来调整。

3.  **分词**
    *   全文索引依赖于分词器来将文本拆分成独立的单词（Token）。
    *   默认的分词器对于英文等西文语言（以空格分隔）效果很好，但对中文、日文等没有空格分隔的语言支持不佳。
    *   **中文全文检索**：MySQL 5.7 之后支持了 n-gram 分词器（适用于中日韩文）和 MeCab 分词器（适用于日文）。你需要指定分词器来创建支持中文的全文索引。
        ```sql
        CREATE TABLE articles_zh (
            id INT UNSIGNED AUTO_INCREMENT NOT NULL PRIMARY KEY,
            content TEXT,
            FULLTEXT (content) WITH PARSER ngram
        ) ENGINE=InnoDB;
        ```

### 6. 优缺点总结

**优点：**
*   **速度快**：相比 `LIKE '%...%'`，在大数据量下性能提升几个数量级。
*   **相关性排序**：能够按与查询的相关性对结果进行智能排序。
*   **功能强大**：布尔模式提供了灵活的查询逻辑。

**缺点：**
*   **存储开销**：全文索引会占用额外的磁盘空间。
*   **维护成本**：对索引列的增删改操作，需要更新全文索引，会有一定的性能开销。
*   **配置复杂**：需要理解停用词、最小词长、分词器等概念以达到最佳效果。
*   **对中文支持需额外配置**：默认分词器不适用于中文。

### 适用场景

*   博客、新闻网站的站内搜索。
*   电子商务平台的产品描述搜索。
*   文档管理系统、知识库的内容检索。
*   任何需要在大段文本中快速查找关键词的应用。

对于超大规模或要求极高的搜索场景，专业的搜索引擎如 **Elasticsearch** 或 **Apache Solr** 通常是更强大的选择，但 MySQL 的全文索引对于许多内置于应用中的、中小规模的搜索需求来说，已经是一个非常强大和方便的解决方案。